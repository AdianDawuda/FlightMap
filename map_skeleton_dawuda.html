<!DOCTYPE html>

<head>
    <meta name="author" content="Adian Dawuda" />
    <meta name="description" Content="Mobile Web Map" />
    <meta charset="UTF-8">
    <title>Map - Adian Dawuda</title>
    <link rel="icon" type="image/x-icon" href="data/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://openlayers.org/en/v5.3.0/css/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://openlayers.org/en/v5.3.0/build/ol.js" type="text/javascript"></script>
    <script type="text/javascript">
        function init() {

            let jsonData; // Declare jsonData as a global variable


            const skyURL = "https://opensky-network.org/api/states/all?lamin=45.8389&lomin=5.9962&lamax=47.8229&lomax=10.5226";

            // Define constants for property indexes
            const INDEX_ICAO24 = 0;
            const INDEX_CALLSIGN = 1;
            const INDEX_ORIGIN_COUNTRY = 2;
            const INDEX_TIME_POSITION = 3;
            const INDEX_LAST_CONTACT = 4;
            const INDEX_LONGITUDE = 5;
            const INDEX_LATITUDE = 6;
            const INDEX_BARO_ALTITUDE = 7;
            const INDEX_ON_GROUND = 8;
            const INDEX_VELOCITY = 9;
            const INDEX_TRUE_TRACK = 10;
            const INDEX_VERTICAL_RATE = 11;
            const INDEX_SENSORS = 12;
            const INDEX_GEO_ALTITUDE = 13;
            const INDEX_SQUAWK = 14;
            const INDEX_SPI = 15;
            const INDEX_POSITION_SOURCE = 16;
            const INDEX_CATEGORY = 17;

            function fetchData(url) {
                return fetch(url)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response not ok!");
                        }
                        // Return response JSON data
                        return response.json();
                    })
                    .then((data) => {
                        // Assign JSON data to the global variable
                        jsonData = data;
                        return jsonData;
                    })
                    .catch((error) => {
                        console.error("Error fetching data:", error);
                    });
            }

            // Call the fetchData function with the skyURL
            fetchData(skyURL)
                .then(() => {
                    let aircraftFeatures = extractAircraftFeatures(jsonData)
                    for (const data of aircraftFeatures) {
                        drawMarker(data)
                    }

                    // Vector source and layer
                    const vectorSource = new ol.source.Vector({
                        features: features,
                    });
                    const vectorLayer = new ol.layer.Vector({
                        source: vectorSource,
                    });


                    const rasterLayer = new ol.layer.Tile({
                        source: new ol.source.OSM(),
                    });

                    const map = new ol.Map({
                        layers: [rasterLayer, vectorLayer],
                        target: document.getElementById('map'),
                        controls: ol.control.defaults({
                            attributionOptions: ({
                                collapsible: false
                            })
                        }).extend([new ol.control.ScaleLine()]),
                        view: new ol.View({
                            center: ol.proj.transform([8, 47], 'EPSG:4326', 'EPSG:3857'),
                            zoom: 10,
                        }),
                    });

                    const element = document.getElementById('popup');

                    const popup = new ol.Overlay({
                        element: element,
                        positioning: 'bottom-center',
                        stopEvent: false,
                    });
                    map.addOverlay(popup);

                    let popover;

                    function disposePopover() {
                        if (popover) {
                            popover.dispose();
                            popover = undefined;
                        }
                    }
                    // display popup on click
                    map.on('singleclick', function (evt) {
                        const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
                            return feature;
                        });
                        disposePopover();
                        if (!feature) {
                            return;
                        }
                        popup.setPosition(evt.coordinate);
                        popover = new bootstrap.Popover(element, {
                            placement: 'top',
                            html: true,
                            content: feature.get('name') + '<br>Country of origin: ' + feature.get('origin'),
                        });
                        popover.show();
                    });

                    // change mouse cursor when over marker
                    map.on('pointermove', function (e) {
                        const pixel = map.getEventPixel(e.originalEvent);
                        const hit = map.hasFeatureAtPixel(pixel);
                        map.getTarget().style.cursor = hit ? 'pointer' : '';
                    });
                    // Close the popup when the map is moved
                    map.on('movestart', disposePopover);
                });

            function extractAircraftFeatures(jsonData) {
                // Map aircraft data to feature data format
                const aircraftFeatures = jsonData.states.map((aircraft) => ({
                    coordinates: ol.proj.transform([aircraft[INDEX_LONGITUDE], aircraft[INDEX_LATITUDE]], 'EPSG:4326', 'EPSG:3857'),
                    name: aircraft[INDEX_CALLSIGN],
                    origin: aircraft[INDEX_ORIGIN_COUNTRY],
                    imageSrc: 'data/plane-icon.png',
                    size: 1.0 // You may adjust the size as needed
                }));
                return aircraftFeatures;
            }

        }
        const features = [];
        function drawMarker(posMarker) {

            const feature = new ol.Feature({
                geometry: new ol.geom.Point(posMarker.coordinates),
                name: posMarker.name,
                origin: posMarker.origin,
            });
            const iconStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 46],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    src: posMarker.imageSrc,
                    scale: posMarker.size,
                }),
            });
            feature.setStyle(iconStyle);
            features.push(feature);
        }

    </script>
</head>

<body onload="init();">

    <div id="header">
        <p>Web Map - Adian</p>
    </div>

    <div id="map">
        <div id="popup">

        </div>
    </div>

    <div id="footer">

    </div>

</body>

</html>