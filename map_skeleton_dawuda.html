<!DOCTYPE html>
<html>

<head>
    <!-- Metadata -->
    <meta name="author" content="Adian Dawuda, Nimrod M. Kibet, Noah Greupner" />
    <meta name="description" Content="Flight tracker Austria" />
    <meta charset="UTF-8">
    <!-- Title and Icon -->
    <title>Flight tracker Austria</title>
    <link rel="icon" type="image/x-icon" href="data/favicon.ico">
    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="styles_noah.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://openlayers.org/en/v5.3.0/css/ol.css" type="text/css">
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://openlayers.org/en/v5.3.0/build/ol.js" type="text/javascript"></script>
    <!-- JavaScript Code -->
    <script type="text/javascript">
        // Initialize the map and related functionalities

        let features = [];

            

        function init() {
            let jsonData;
            const skyURL = "https://opensky-network.org/api/states/all?lamin=46.3721&lomin=9.5308&lamax=49.0205&lomax=17.1607";

            // Define constants for JSON data indices
            const INDEX_ICAO24 = 0;
            const INDEX_CALLSIGN = 1;
            const INDEX_ORIGIN_COUNTRY = 2;
            const INDEX_TIME_POSITION = 3;
            const INDEX_LAST_CONTACT = 4;
            const INDEX_LONGITUDE = 5;
            const INDEX_LATITUDE = 6;
            const INDEX_BARO_ALTITUDE = 7;
            const INDEX_ON_GROUND = 8;
            const INDEX_VELOCITY = 9;
            const INDEX_TRUE_TRACK = 10;
            const INDEX_VERTICAL_RATE = 11;
            const INDEX_SENSORS = 12;
            const INDEX_GEO_ALTITUDE = 13;
            const INDEX_SQUAWK = 14;
            const INDEX_SPI = 15;
            const INDEX_POSITION_SOURCE = 16;
            const INDEX_CATEGORY = 17;



                // Create layers and initialize the map
                let vectorSource = new ol.source.Vector({
                        features: features,
                    });
                    let vectorLayer = new ol.layer.Vector({
                        source: vectorSource,
                    });
                    let rasterLayer = new ol.layer.Tile({
                        source: new ol.source.XYZ({
                        url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}@2x.png?api_key=1ccc1cb9-0c96-41ad-84ae-cf7022a50d03',
                        attributions: [
                            '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a>',
                            '&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',
                            '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>'
                        ],
                        tilePixelRatio: 2,
                        maxZoom: 20
                        })
                    });

                    let map = new ol.Map({
                        layers: [rasterLayer, vectorLayer],
                        target: document.getElementById('map'),
                        controls: ol.control.defaults({
                            attributionOptions: ({
                                collapsible: false
                            })
                        }).extend([new ol.control.ScaleLine()]),
                        view: new ol.View({
                            center: ol.proj.transform([13.4, 47.8], 'EPSG:4326', 'EPSG:3857'),
                            zoom: 7.5,
                        }),
                    });


            fetchAndDraw();
            setInterval(function(){
                fetchAndDraw()
            }, 20000);

            
            // Function to fetch JSON data from the specified URL
            function fetchData(url) {
                return fetch(url)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response not ok!");
                        }
                        // Return response JSON data
                        return response.json();
                    })
                    .then((data) => {
                        // Assign JSON data to jsonData
                        jsonData = data;
                        return jsonData;
                    })
                    .catch((error) => {
                        console.error("Error fetching data:", error);
                    });
            }

            function fetchAndDraw() {

            // Fetch data from the specified URL
            fetchData(skyURL)
                .then(() => {
                    // Clear existing features
                // Array to store features for markers
                vectorSource.clear();
                features = [];
                    console.log(features);
                    // Extract aircraft features from JSON data
                    let aircraftFeatures = extractAircraftFeatures(jsonData);
                    // Draw markers for each aircraft feature
                    for (const data of aircraftFeatures) {
                        drawMarker(data);
                    }

            vectorSource.cle
            // Update the vector source with new features
            vectorSource.addFeatures(features);

            // Refresh the vector layer
            vectorLayer.getSource().refresh();

                    console.log(features);
                    // Initialize popups for markers on the map
                    initPopups(map);
                });

            }

            // Function to initialize popups for markers on the map
            function initPopups(map) {
                // Create popup components
                const element = document.getElementById('popup');
                const popup = new ol.Overlay({
                    element: element,
                    positioning: 'bottom-center',
                    stopEvent: false,
                });
                map.addOverlay(popup);

                let popover;

                function disposePopover() {
                    if (popover) {
                        popover.dispose();
                        popover = undefined;
                    }
                }

                // Display popup on click
                map.on('singleclick', function (evt) {
                    const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
                        return feature;
                    });
                    disposePopover();
                    if (!feature) {
                        return;
                    }
                    popup.setPosition(evt.coordinate);
                    popover = new bootstrap.Popover(element, {
                        placement: 'top',
                        html: true,
                        content: 'Flight information: ' + '<br>Aircraft call sign: ' + feature.get('name') + '<br>Country of origin: ' + feature.get('origin'),
                    });
                    popover.show();
                });

                // Change mouse cursor when over marker
                map.on('pointermove', function (e) {
                    const pixel = map.getEventPixel(e.originalEvent);
                    const hit = map.hasFeatureAtPixel(pixel);
                    map.getTarget().style.cursor = hit ? 'pointer' : '';
                });

                // Close the popup when the map is moved
                map.on('movestart', disposePopover);
            }

            // Function to extract aircraft features from JSON data
            function extractAircraftFeatures(jsonData) {
                const aircraftFeatures = jsonData.states.map((aircraft) => ({
                    coordinates: ol.proj.transform([aircraft[INDEX_LONGITUDE], aircraft[INDEX_LATITUDE]], 'EPSG:4326', 'EPSG:3857'),
                    name: aircraft[INDEX_CALLSIGN],
                    origin: aircraft[INDEX_ORIGIN_COUNTRY],
                    imageSrc: 'data/plane-icon.png',
                    size: 0.5
                }));
                return aircraftFeatures;
            }
        }



        // Function to draw a marker on the map
        function drawMarker(posMarker) {
            const feature = new ol.Feature({
                geometry: new ol.geom.Point(posMarker.coordinates),
                name: posMarker.name,
                origin: posMarker.origin,
            });
            const iconStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 46],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    src: posMarker.imageSrc,
                    scale: posMarker.size,
                }),
            });
            feature.setStyle(iconStyle);
            features.push(feature);
        }
    </script>
</head>

<body onload="init();">
    <!-- Header -->
    <div id="header">
        <p>Flight Tracker Austria</p>
    </div>
    <!-- Map Container -->
    <div id="map">
        <div id="popup"></div>
    </div>
    <!-- Footer -->
    <div id="footer"></div>
</body>

</html>